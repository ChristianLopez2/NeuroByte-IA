<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Comparativo - NeuroByte-IA</title>
  <link rel="stylesheet" href="/static/styles.css?v=1" />
  <link rel="icon" type="image/png" href="/static/favicon.png">
  <!-- Tabulator -->
  <link href="https://unpkg.com/tabulator-tables@5.6.2/dist/css/tabulator.min.css" rel="stylesheet">
  <script src="https://unpkg.com/tabulator-tables@5.6.2/dist/js/tabulator.min.js"></script>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <style>
    .wrap{max-width:1200px;margin:0 auto;padding:20px}
    .cards{display:grid;grid-template-columns:repeat(4,1fr);gap:14px}
    .card{background:var(--card);border-radius:14px;padding:14px;box-shadow:0 8px 20px rgba(0,0,0,.25)}
    .card h3{margin:0 0 6px 0;font-size:14px;color:var(--muted)}
    .card .val{font-size:28px;font-weight:800;color:var(--ink)}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-top:16px}
    .grid-3{display:grid;grid-template-columns:2fr 1fr 1fr;gap:16px;margin-top:16px}
    .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-top:16px}
    .panel{background:var(--card);border-radius:14px;padding:14px;box-shadow:0 8px 20px rgba(0,0,0,.25)}
    .list{display:grid;gap:8px;margin-top:6px}
    .item{background:#0d1326;border:1px solid rgba(255,255,255,.08);border-radius:10px;padding:10px}
    .muted{color:var(--muted);font-size:12px}

    @media (max-width:1100px){.grid-3{grid-template-columns:1fr}}
    @media (max-width:900px){.cards{grid-template-columns:1fr 1fr}.grid,.grid-2{grid-template-columns:1fr}}
    @media (max-width:600px){.cards{grid-template-columns:1fr}}

    .alerta{padding:10px;border:1px dashed rgba(255,255,255,.25);border-radius:10px;background:#0d1326;color:var(--muted)}
    /* Filtros */
    .filters{display:grid;grid-template-columns:1.4fr 1.2fr 1fr 1fr;gap:10px;margin:12px 0}
    .filters input,.filters select{padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,.08);background:#0d1326;color:var(--ink)}
    .mdrop{position:relative;display:inline-block}
    .mdrop-btn{width:100%;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,.08);background:#0d1326;color:var(--ink);display:flex;justify-content:space-between;align-items:center;gap:8px}
    .mdrop-menu{position:absolute;z-index:30;top:110%;left:0;min-width:260px;max-height:260px;overflow:auto;background:#0d1326;border:1px solid rgba(255,255,255,.1);border-radius:12px;box-shadow:0 8px 26px rgba(0,0,0,.35);padding:8px;display:none}
    .mdrop.open .mdrop-menu{display:block}
    .mdrop-item{display:flex;align-items:center;gap:8px;padding:6px 8px;border-radius:8px}
    .mdrop-item:hover{background:rgba(255,255,255,.06)}
    .chip{display:inline-block;padding:6px 12px;border-radius:999px;border:1px solid rgba(255,255,255,.08);font-size:12px}
  </style>
</head>
<body>
  <div class="nav">
    <div class="brand">Comparativo - NeuroByte-IA</div>
    <div class="legend"><span class="chip">Comparativo</span><span>Pliegos • Propuestas • Contratos</span></div>
  </div>

  <div class="wrap">
    <!-- Filtros y fuente de datos -->
    <div class="panel">
      <div class="filters">
        <select id="tipoSelect" title="Tipo de proceso"></select>

        <!-- Oferentes (multi) -->
        <div class="mdrop" id="mdOferentes">
          <button class="mdrop-btn" type="button"><span id="mdOferentesLabel">Oferentes: Todos</span><span>▾</span></button>
          <div class="mdrop-menu" id="mdOferentesMenu"></div>
        </div>

        <!-- Categorías (multi) -->
        <div class="mdrop" id="mdCategorias">
          <button class="mdrop-btn" type="button"><span id="mdCategoriasLabel">Categorías: Todas</span><span>▾</span></button>
          <div class="mdrop-menu" id="mdCategoriasMenu"></div>
        </div>

        <!-- Riesgo (single) -->
        <div class="mdrop" id="mdRiesgo">
          <button class="mdrop-btn" type="button"><span id="mdRiesgoLabel">Riesgo: Todos</span><span>▾</span></button>
          <div class="mdrop-menu" id="mdRiesgoMenu"></div>
        </div>
      </div>
      <div style="display:flex;gap:10px;flex-wrap:wrap">
        <button id="btnCargarTipo" class="chip">Cargar por tipo</button>
        <button id="btnDemo" class="chip">Refrescar Datos</button>
      </div>
    </div>

    <!-- KPIs -->
    <div class="cards" style="margin:16px 0">
      <div class="card"><h3>Cumplimiento global</h3><div class="val" id="kpiCumplimiento">—</div></div>
      <div class="card"><h3>Riesgos (A/M/B)</h3><div class="val" id="kpiRiesgos">—</div><div class="muted">Riesgo ALTO, MEDIO, BAJO</div></div>
      <div class="card"><h3>Costo</h3><div class="val" id="kpiCosto">—</div></div>
      <div class="card"><h3>Plazo</h3><div class="val" id="kpiPlazo">—</div></div>
    </div>

    <div class="cards" style="margin:6px 0 16px 0">
      <div class="card"><h3>Horas administrativas ahorradas</h3><div class="val" id="kpiHoras">—</div><div class="muted" id="kpiHorasNote"></div></div>
      <div class="card"><h3>Sobre-costo evitado (est.)</h3><div class="val" id="kpiCostoEv">—</div><div class="muted" id="kpiCostoEvNote"></div></div>
      <div class="card"><h3>Cláusulas riesgosas detectadas</h3><div class="val" id="kpiRiesgosDetect">—</div><div class="muted">prioriza ALTO, MEDIO, BAJO</div></div>
      <div class="card"><h3>Trazabilidad</h3><div class="val" id="kpiTraza">—</div><div class="muted" id="kpiTrazaNote"></div></div>
    </div>

    <!-- Gráficos -->
    <div class="grid">
      <div class="panel"><h3 style="margin:0 0 8px 0">Cumplimiento por categoría</h3><canvas id="radar"></canvas></div>
      <div class="panel"><h3 style="margin:0 0 8px 0">Cumplimiento por sub-categoría</h3><canvas id="barras"></canvas></div>
    </div>

    <!-- Tablas + Insights -->
    <div class="grid">
      <div class="panel">
        <h3 style="margin:0 0 8px 0">Riesgos detectados</h3>
        <div id="tablaRiesgos"></div>
      </div>
      <div class="panel">
        <h3 style="margin:0 0 8px 0">Requisitos × Oferentes</h3>
        <div id="tablaComparativa" class="tabla-scroll"></div>
      </div>
    </div>

    <!-- NUEVO: Top + Trazabilidad en la misma fila -->
    <div class="grid-2">
      <div class="panel">
        <h3 style="margin:0 0 8px 0">Top cláusulas riesgosas</h3>
        <div class="list" id="listaTopRiesgos"></div>
      </div>
      <div class="panel">
        <h3 style="margin:0 0 8px 0">Trazabilidad y evidencia</h3>
        <div class="list" id="listaTraza"></div>
      </div>
    </div>
  </div>

<script>
(()=>{'use strict';

/* ===================== Tipos & parámetro ===================== */
async function cargarTipos(){
  const r = await fetch('/api/tipos-licitacion', { cache: 'no-store' });
  if (!r.ok) throw new Error('No pude listar /static/tipos');
  const arr = await r.json();
  //arr.unshift({ id: 'auto', label: 'Detectar automáticamente' });
  return arr;
}
function slug(s){return (s||'').normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase().replace(/[^a-z0-9]+/g,'_').replace(/^_|_$/g,'');}
function resolveProcessFromParam(){
  const url = new URL(location.href);
  const raw = url.searchParams.get('process') || localStorage.getItem('processSelection');
  if (!raw || raw==='auto') return null;
  try { return JSON.parse(raw); } catch { return null; }
}
(async()=>{
  const tipos = await cargarTipos();
  const sel = document.querySelector('#tipoSelect');
  sel.innerHTML = '';
  tipos.forEach(t=>{
    const opt=document.createElement('option');
    opt.value=t.id; opt.textContent=t.label;
    sel.appendChild(opt);
  });
  sel.value='auto';
  await preloadFromProcessParam();
})();
async function preloadFromProcessParam(){
  const proc = resolveProcessFromParam();
  if (!proc || !proc.familia || !proc.procedimiento) return false;
  const fam = slug(proc.familia), pro = slug(proc.procedimiento);
  const fnameA = `${fam}__${pro}.json`, fnameB = `${fam}_${pro}.json`;
  const sel = document.querySelector('#tipoSelect');
  const opts = Array.from(sel?.options || []);
  const match = opts.find(o=>{
    const v=(o.value||'').toLowerCase(), t=slug(o.textContent||'');
    return v.endsWith(fnameA) || v.endsWith(fnameB) || v.includes(`${fam}__${pro}`) || v.includes(`${fam}_${pro}`) || (t.includes(fam)&&t.includes(pro));
  });
  if (match){ sel.value=match.value; await cargarTipoSeleccionado(); return true; }
  const url = `/static/tipos/${fnameA}`;
  const ok  = await cargarDesde(url, `${proc.familia} — ${proc.procedimiento}`);
  if (ok){ const opt=new Option(`${proc.familia} — ${proc.procedimiento}`, fnameA); sel.add(opt); sel.value=opt.value; }
  return ok;
}

/* ===================== Estado global ===================== */
const ASSUMPTIONS = { reviewMinutesPerReq:12, automationFactor:0.7, avgCostOfErrorUSD:500,
  riskCostWeights:{ALTO:3000,MEDIO:800,BAJO:200}, negotiationOverspendPct:0.03 };
const pesosPorDefecto = { Legal:0.4, Tecnica:0.4, Administrativa:0.2 };
let DATA=null; let chartRadar=null, chartBarras=null;
const $ = s=>document.querySelector(s);
const fmtNum = n => (n==null||Number.isNaN(n)) ? '—' : new Intl.NumberFormat('es-EC').format(Math.round(n));
const fmtDays = v => (v==null || !isFinite(Number(v))) ? 'N/D' : `${Number(v)} d`;

/* ===================== UI helpers ===================== */
function mostrarMensaje(texto) {
  let cont = document.getElementById('contenedor-datos');
  if (!cont) {
    cont = document.createElement('div');
    cont.id = 'contenedor-datos';
    cont.className = 'panel';
    document.querySelector('.wrap').prepend(cont);
  }
  cont.style.display = 'block';
  cont.innerHTML = `<div class="alerta">${texto}</div>`;
}
function renderizarDatos(raw) {
  const cont = document.getElementById('contenedor-datos');
  if (cont) cont.style.display = 'none';
  DATA = normalizeComparativo(raw);
  hydrateFilters();
  onFiltersChange();
}

/* ===================== Normalizador ===================== */
function normalizeComparativo(input){
  if (Array.isArray(input)) {
    const lastWithReqs = [...input].reverse().find(p => p?.requisitos?.length);
    const requisitos = lastWithReqs?.requisitos || [];
    const referencia = lastWithReqs?.referencia || {};
    const pesosCategoria = lastWithReqs?.pesosCategoria || { Legal:0.4, Tecnica:0.4, Administrativa:0.2 };
    const allOferentes = [];
    input.forEach(p => {
      const rucRaiz = p?.ruc_validacion?.ruc || null;
      (p?.oferentes || []).forEach(o => allOferentes.push({...o, ruc:o.ruc || rucRaiz || null}));
    });
    return { procesoId:lastWithReqs?.procesoId || 'EXT', referencia, requisitos,
             oferentes: dedupeOferentesByRuc(allOferentes), pesosCategoria };
  }
  if (input && input.requisitos && input.oferentes) {
    if (input.ruc_validacion?.ruc && input.oferentes.length === 1 && !input.oferentes[0].ruc) {
      input.oferentes[0].ruc = input.ruc_validacion.ruc;
    }
    input.oferentes = dedupeOferentesByRuc(input.oferentes);
    return input;
  }
  return input || {};
}

/* ===================== Carga de tipo ===================== */
async function cargarDesde(url, labelForMsg){
  const res = await fetch(url, { cache: 'no-store' });
  if (!res.ok) { mostrarMensaje(`No hay procesos activos para: ${labelForMsg || url}`); return false; }
  let raw;
  try { raw = await res.json(); } catch { mostrarMensaje(`No hay procesos activos para: ${labelForMsg || url}`); return false; }
  if (!raw || (Array.isArray(raw) && raw.length === 0)) { mostrarMensaje(`No hay procesos activos para: ${labelForMsg || url}`); return false; }
  renderizarDatos(raw);
  return true;
}
async function cargarTipoSeleccionado(){
  const sel = $('#tipoSelect');
  const value = (sel?.value || '').trim();
  if (!value) { mostrarMensaje('Selecciona un tipo para cargar datos.'); return; }
  if (value === 'auto') {
    let tipos = [];
    try { tipos = await cargarTipos(); } catch {}
    const firstReal = tipos.find(t => t.id && t.id !== 'auto');
    if (!firstReal) { mostrarMensaje('Sin tipos disponibles.'); return; }
    const url = firstReal.id.endsWith('.json') && !firstReal.id.startsWith('/static/') ? `/static/tipos/${firstReal.id}` : firstReal.id;
    await cargarDesde(url, firstReal.label || firstReal.id);
    return;
  }
  const url = value.endsWith('.json') && !value.startsWith('/static/') ? `/static/tipos/${value}` : value;
  await cargarDesde(url, value);
}
document.getElementById('btnCargarTipo').addEventListener('click', cargarTipoSeleccionado);
document.getElementById('btnDemo').addEventListener('click', cargarTipoSeleccionado);

/* ===================== Métricas ===================== */
function scoreEstado(e){ if(!e) return 0; const x=e.toUpperCase(); return x==='CUMPLE'?1: x==='PARCIAL'?0.5:0; }
function reqEnCategorias(req, catsSel){ return catsSel.includes((req.categoria||'General')); }
function calcularCumplimientoOferente(data,o,catsSel){
  const pesos=data.pesosCategoria||pesosPorDefecto; let s=0,d=0;
  for(const r of data.requisitos){
    if(!reqEnCategorias(r,catsSel)) continue;
    const w=(r.peso??1)*(pesos[r.categoria]??0.333);
    const c=(o.cumplimientos||[]).find(x=>x.reqId===r.id);
    s+=scoreEstado(c?.estado)*w; d+=w;
  }
  return d? (s/d)*100:0;
}
function cumplimientoPorCategoria(data,o,catsSel){
  const g={}; for(const r of data.requisitos){
    if(!reqEnCategorias(r,catsSel)) continue;
    const cat=r.categoria||'General'; g[cat] ||= {s:0,d:0};
    const c=(o.cumplimientos||[]).find(x=>x.reqId===r.id);
    g[cat].s+=scoreEstado(c?.estado)*(r.peso??1); g[cat].d+=(r.peso??1);
  } return Object.fromEntries(Object.entries(g).map(([k,v])=>[k,v.d?(v.s/v.d)*100:0]));
}
function cumplimientoPorSub(data,o,catsSel){
  const g={}; for(const r of data.requisitos){
    if(!reqEnCategorias(r,catsSel)) continue;
    const key=`${r.categoria||'General'} • ${r.sub||'—'}`; g[key] ||= {s:0,d:0};
    const c=(o.cumplimientos||[]).find(x=>x.reqId===r.id);
    g[key].s+=scoreEstado(c?.estado)*(r.peso??1); g[key].d+=(r.peso??1);
  } return Object.fromEntries(Object.entries(g).map(([k,v])=>[k,v.d?(v.s/v.d)*100:0]));
}
function calcularKPIs(data,ids,catsSel,riesgoSel){
  const of=data.oferentes.filter(o=>ids.includes(o.id));
  const prom=of.length? of.map(o=>calcularCumplimientoOferente(data,o,catsSel)).reduce((a,b)=>a+b)/of.length:0;
  let A=0,M=0,B=0;
  of.forEach(o=> (o.riesgos||[]).forEach(r=>{
    const n=(r.nivel||'').toString().toUpperCase().trim();
    if(riesgoSel!=='ALL' && n!==riesgoSel) return;
    if(n==='ALTO')A++; else if(n==='MEDIO')M++; else B++;
  }));
  const refC=data.referencia?.costo, refP=data.referencia?.plazo_dias;
  const deltaC=refC!=null? Math.min(...of.map(o=>Math.abs((o.costo??refC)-refC))):null;
  const deltaP=refP!=null? Math.min(...of.map(o=>Math.abs((o.plazo_dias??refP)-refP))):null;
  return {prom,riesgos:{A,M,B},deltaC,refC,deltaP,refP};
}
function calcularImpacto(data,ids,catsSel,riesgoSel){
  const of=data.oferentes.filter(o=>ids.includes(o.id));
  const reqCount=(data.requisitos||[]).filter(r=>reqEnCategorias(r,catsSel)).length;
  const saved=(reqCount*ASSUMPTIONS.reviewMinutesPerReq)*ASSUMPTIONS.automationFactor/60;
  let riskCost=0,a=0,m=0,b=0;
  of.forEach(o=> (o.riesgos||[]).forEach(r=>{
    const n=(r.nivel||'').toString().toUpperCase().trim();
    if(riesgoSel!=='ALL' && n!==riesgoSel) return;
    if(n==='ALTO'){a++; riskCost+=ASSUMPTIONS.riskCostWeights.ALTO}
    else if(n==='MEDIO'){m++; riskCost+=ASSUMPTIONS.riskCostWeights.MEDIO}
    else {b++; riskCost+=ASSUMPTIONS.riskCostWeights.BAJO}
  }));
  const avg=of.length? of.map(o=>calcularCumplimientoOferente(data,o,catsSel)).reduce((x,y)=>x+y)/of.length:0;
  const overspend=(data.referencia?.costo||0)*(1-avg/100)*ASSUMPTIONS.negotiationOverspendPct;
  let withE=0,total=0,traces=[];
  of.forEach(o=> (o.cumplimientos||[]).forEach(c=>{
    const req = (data.requisitos||[]).find(r=>r.id===c.reqId);
    if(!req || !reqEnCategorias(req,catsSel)) return;
    total++; const has=!!(c.evidencia||c.enlace);
    if(has){withE++; traces.push({oferente:o.nombre,reqId:c.reqId,evidencia:c.evidencia||'',enlace:c.enlace||''});}
  }));
  const tracePct=total? (withE/total)*100:0;
  return {savedHours:saved,a,m,b,avoidedUSD:Math.round(riskCost+overspend),overspend,riskCost,tracePct,traces};
}

/* ===================== Droplists ===================== */
function makeMultiDroplist(el,items,labelEl,defaultText){
  el.querySelector('.mdrop-btn').addEventListener('click',()=>{ el.classList.toggle('open'); });
  const menu=el.querySelector('.mdrop-menu'); menu.innerHTML='';
  items.forEach(it=>{
    const row=document.createElement('label'); row.className='mdrop-item';
    const cb=document.createElement('input'); cb.type='checkbox'; cb.value=it.value; cb.checked=it.checked??true;
    const sp=document.createElement('span'); sp.textContent=it.label;
    row.appendChild(cb); row.appendChild(sp); menu.appendChild(row);
  });
  const update=()=>{ 
    const labels = Array.from(menu.querySelectorAll('input:checked'))
      .map(i=>items.find(x=>x.value==i.value))
      .filter(Boolean)
      .map(it=>it.label)
      .filter(Boolean);
    labelEl.textContent = labels.length ? labels.join(', ') : defaultText; 
  };
  menu.addEventListener('change',()=>{ update(); onFiltersChange(); });
  document.addEventListener('click',e=>{ if(!el.contains(e.target)) el.classList.remove('open'); });
  update();
  return ()=> Array.from(menu.querySelectorAll('input:checked')).map(i=>i.value);
}
function makeSingleDroplist(el,items,labelEl,defaultText){
  el.querySelector('.mdrop-btn').addEventListener('click',()=>{ el.classList.toggle('open'); });
  const menu=el.querySelector('.mdrop-menu'); menu.innerHTML='';
  items.forEach(it=>{
    const row=document.createElement('div'); row.className='mdrop-item'; row.style.cursor='pointer'; row.textContent=it.label;
    row.addEventListener('click',()=>{ labelEl.textContent=it.label; el.dataset.value=it.value; el.classList.remove('open'); onFiltersChange(); });
    menu.appendChild(row);
  });
  document.addEventListener('click',e=>{ if(!el.contains(e.target)) el.classList.remove('open'); });
  labelEl.textContent=defaultText; el.dataset.value=items[0]?.value??'ALL';
  return ()=> el.dataset.value;
}

let getOferentesRaw=()=>[], getCategorias=()=>[], getRiesgo=()=>'ALL';

// Oferentes efectivos = selección del multiselect ∩ filtro por riesgo
function getOferentes(){
  const ids = getOferentesRaw();
  const riesgo = getRiesgo();
  if (riesgo === 'ALL') return ids;

  const idsSet = new Set(ids);
  const filtered = (DATA.oferentes || [])
    .filter(o => idsSet.has(o.id))
    .filter(o => (o.riesgos || []).some(
      r => String(r.nivel || '').toUpperCase().trim() === riesgo
    ));
  return filtered.map(o => o.id);
}

async function hydrateFilters(){
  // Oferentes (multi) — filtra nombres vacíos o "null"
  const ofItems = (DATA.oferentes||[])
    .filter(o => o && o.nombre && String(o.nombre).trim().toLowerCase() !== 'null')
    .map(o=>({ label:o.nombre, value:o.id, checked:true }));
  getOferentesRaw = makeMultiDroplist($('#mdOferentes'), ofItems, $('#mdOferentesLabel'), 'Oferentes: Ninguno');

  // Categorías
  const cats = Array.from(new Set((DATA.requisitos||[]).map(r=>r.categoria||'General')));
  const catItems = cats.map(c=>({ label:c, value:c, checked:true }));
  getCategorias = makeMultiDroplist($('#mdCategorias'), catItems, $('#mdCategoriasLabel'), 'Categorías: Ninguna');

  // Riesgo
  const setR = new Set();
  (DATA.oferentes||[]).forEach(o => (o.riesgos||[]).forEach(r => setR.add((r.nivel||'').toString().toUpperCase().trim())));
  const nivelesOrden = ['ALTO','MEDIO','BAJO'];
  const niveles = nivelesOrden.filter(n => setR.has(n));
  const riskItems = [{ label:'Todos', value:'ALL' }].concat(niveles.map(n => ({ label: n.charAt(0)+n.slice(1).toLowerCase(), value: n })));
  getRiesgo = makeSingleDroplist($('#mdRiesgo'), riskItems, $('#mdRiesgoLabel'), 'Riesgo: Todos');
}

/* ===================== Render ===================== */
function etiquetaEstado(e){ const m={CUMPLE:'✔️',PARCIAL:'➗','NO CUMPLE':'❌'}; return m[(e||'NO CUMPLE').toUpperCase()]||'❌'; }

function renderKPIs(){
  const ids=getOferentes(), catsSel=getCategorias(), riesgo=getRiesgo();
  const k=calcularKPIs(DATA,ids,catsSel,riesgo);
  $('#kpiCumplimiento').textContent=`${k.prom.toFixed(1)}%`;
  $('#kpiRiesgos').textContent=`${k.riesgos.A}/${k.riesgos.M}/${k.riesgos.B}`;

  if (ids.length===2) {
    const [idA,idB]=ids;
    const oA=DATA.oferentes.find(x=>x.id===idA)||{};
    const oB=DATA.oferentes.find(x=>x.id===idB)||{};
    $('#kpiCosto').textContent = `${fmtNum(oA.costo)} vs ${fmtNum(oB.costo)}`;
    $('#kpiPlazo').textContent = `${fmtDays(oA.plazo_dias)} vs ${fmtDays(oB.plazo_dias)}`;
  } else if (ids.length===1) {
    const o=DATA.oferentes.find(x=>x.id===ids[0])||{};
    $('#kpiCosto').textContent = `${fmtNum(o.costo)}`;
    $('#kpiPlazo').textContent = `${fmtDays(o.plazo_dias)}`;
  } else {
    $('#kpiCosto').textContent=(k.refC!=null)? ` ${fmtNum(k.deltaC)} vs ${fmtNum(k.refC)}`:'—';
    $('#kpiPlazo').textContent=(k.refP!=null)? `A ${k.deltaP} d vs ${k.refP} d`:'—';
  }
}
function renderImpacto(){
  const ids=getOferentes(), catsSel=getCategorias(), riesgo=getRiesgo();
  const x=calcularImpacto(DATA,ids,catsSel,riesgo);
  $('#kpiHoras').textContent=`${x.savedHours.toFixed(1)} h`;
  $('#kpiHorasNote').textContent=`asumiendo ${ASSUMPTIONS.reviewMinutesPerReq} min/req y ${Math.round(ASSUMPTIONS.automationFactor*100)}% automatizado`;
  $('#kpiCostoEv').textContent=`$ ${fmtNum(x.avoidedUSD)}`;
  $('#kpiCostoEvNote').textContent=`riesgos: $${fmtNum(x.riskCost)} + negociación: $${fmtNum(x.overspend)}`;
  $('#kpiRiesgosDetect').textContent=`${x.a}/${x.m}/${x.b}`;
  $('#kpiTraza').textContent=`${x.tracePct.toFixed(0)}%`;
  $('#kpiTrazaNote').textContent=`de cumplimientos con evidencia/enlace`;

  // Top riesgos (filtrados)
  const idsSel=new Set(ids);
  const top=[]; DATA.oferentes.filter(o=>idsSel.has(o.id)).forEach(o=> (o.riesgos||[]).forEach(r=> top.push({...r,nivel:(r.nivel||'').toString().toUpperCase().trim(),oferente:o.nombre}) ));
  top.sort((a,b)=>({ALTO:3,MEDIO:2,BAJO:1}[b.nivel]-({ALTO:3,MEDIO:2,BAJO:1}[a.nivel])));
  const cont=$('#listaTopRiesgos'); cont.innerHTML='';
  top.slice(0,6).forEach(r=>{
    const div=document.createElement('div'); div.className='item';
    div.innerHTML=`<div><b>${r.nivel}</b> · ${r.clausula}${r.pagina?` (p.${r.pagina})`:''} · <span class="muted">${r.oferente}</span></div><div>${r.descripcion||''}</div>`;
    cont.appendChild(div);
  });

  const t=$('#listaTraza'); t.innerHTML='';
  x.traces.slice(0,6).forEach(ev=>{
    const div=document.createElement('div'); div.className='item';
    const link=ev.enlace?` <a href="${ev.enlace}" target="_blank">ver evidencia</a>`:'';
    div.innerHTML=`<div><b>${ev.oferente}</b> · Req ${ev.reqId}</div><div>${ev.evidencia||'—'}${link}</div>`;
    t.appendChild(div);
  });
}
function renderRadar(){
  // ahora: DONA (multi-dataset = anillos concéntricos, uno por oferente)
  chartRadar?.destroy();

  const ids = getOferentes();
  const catsSel = getCategorias();

  // Etiquetas = categorías filtradas
  const cats = Array.from(new Set(
    (DATA.requisitos || [])
      .filter(r => reqEnCategorias(r, catsSel))
      .map(r => r.categoria || 'General')
  ));

  // Un dataset por oferente (Chart.js mostrará anillos concéntricos)
  const datasets = ids.map(id => {
    const o = DATA.oferentes.find(x => x.id === id);
    const porCat = cumplimientoPorCategoria(DATA, o, catsSel); // {cat: %}

    return {
      label: o?.nombre || id,
      data: cats.map(c => porCat[c] || 0),
      // sin colores manuales: Chart.js los asigna automáticamente
      // borde/estilo por defecto (ok para doughnut)
    };
  });

  chartRadar = new Chart($('#radar'), {
    type: 'doughnut',
    data: { labels: cats, datasets },
    options: {
      responsive: true,
      cutout: '55%', // grosor de la dona (ajusta a gusto)
      plugins: {
        legend: { position: 'right' },
        tooltip: {
          callbacks: {
            label: (ctx) => {
              const val = (ctx.parsed || 0);
              return `${ctx.dataset.label}: ${ctx.label} – ${val.toFixed(1)}%`;
            }
          }
        }
      }
    }
  });
}
function renderBarras(){
  chartBarras?.destroy();
  const ids=getOferentes(), catsSel=getCategorias();
  const all=new Set(); DATA.oferentes.forEach(o=>{ const por=cumplimientoPorSub(DATA,o,catsSel); Object.keys(por).forEach(k=>all.add(k)); });
  const keys=Array.from(all);
  const datasets=ids.map(id=>{
    const o=DATA.oferentes.find(x=>x.id===id);
    const por=cumplimientoPorSub(DATA,o,catsSel);
    return {label:o?.nombre||id,data:keys.map(k=>por[k]||0)};
  });
  chartBarras=new Chart($('#barras'),{type:'bar',data:{labels:keys,datasets},options:{scales:{y:{beginAtZero:true,max:100}}}});
}
function renderTablas(){
  const ofSel = getOferentes(); const catsSel = getCategorias(); const riesgo = getRiesgo();
  const nombres = Object.fromEntries((DATA.oferentes||[]).map(o=>[o.id,o.nombre]));
  const cols = [{title:"Requisito",field:"req"},{title:"Categoría",field:"cat"}]
    .concat(ofSel.map(id=>({title:nombres[id]||id,field:id,hozAlign:"center"})));
  const rows = (DATA.requisitos||[])
    .filter(r=>catsSel.includes(r.categoria||'General'))
    .map(r=>{
      const row={ req:`${r.texto} ${r.clausula&&r.clausula!=='—'?`(Cl. ${r.clausula})`:''}`, cat:r.categoria||'General' };
      for(const id of ofSel){
        const of = DATA.oferentes.find(o=>o.id===id);
        const c = (of?.cumplimientos||[]).find(x=>x.reqId===r.id);
        row[id] = (c && c.estado) ? (c.estado.toUpperCase()==='CUMPLE'?'✔️': c.estado.toUpperCase()==='PARCIAL'?'➗':'❌') : '❌';
      }
      return row;
    });
  const riesgoRows = DATA.oferentes
    .filter(o=>ofSel.includes(o.id))
    .flatMap(o=>(o.riesgos||[]).map(r=>({
      oferente:o.nombre,
      nivel:(r.nivel||'').toString().toUpperCase().trim(),
      clausula:r.clausula||'—',
      pagina:r.pagina??'',
      descripcion:r.descripcion||''
    })))
    .filter(r=> riesgo==='ALL' || r.nivel===riesgo);

  if (window.Tabulator){
    if(!window._tablaComp){
      window._tablaComp = new Tabulator('#tablaComparativa',{height:380,layout:'fitColumns',columns:cols,data:rows});
    }else{
      _tablaComp.setColumns(cols); _tablaComp.setData(rows);
    }
    if(!window._tablaRisk){
      window._tablaRisk = new Tabulator('#tablaRiesgos',{height:380,layout:'fitColumns',data:riesgoRows,columns:[
        {title:'Oferente',field:'oferente'},{title:'Nivel',field:'nivel'},
        {title:'Cláusula',field:'clausula'},{title:'Página',field:'pagina'},
        {title:'Descripción',field:'descripcion',widthGrow:2}
      ]});
    }else{
      _tablaRisk.setData(riesgoRows);
    }
    return;
  }
  // fallback tablas simples
  const makeTable = (el, headers, data) => {
    const toTh = h=>`<th style="text-align:left;padding:8px;border-bottom:1px solid rgba(255,255,255,.1)">${h}</th>`;
    const toTd = v=>`<td style="padding:8px;border-bottom:1px solid rgba(255,255,255,.06)">${v??''}</td>`;
    el.innerHTML = `
      <table style="width:100%;border-collapse:collapse;font-size:14px">
        <thead><tr>${headers.map(toTh).join('')}</tr></thead>
        <tbody>${data.map(r=>`<tr>${headers.map(h=>toTd(r[h]??r[h.field]??r[h.toLowerCase()]??r[h])).join('')}</tr>`).join('')}</tbody>
      </table>`;
  };
  const cmpHeaders = ['Requisito','Categoría'].concat(ofSel.map(id=>nombres[id]||id));
  const cmpData = rows.map(r=>{ const o={ 'Requisito':r.req, 'Categoría':r.cat }; ofSel.forEach(id=> o[nombres[id]||id] = r[id]); return o; });
  makeTable(document.querySelector('#tablaComparativa'), cmpHeaders, cmpData);
  makeTable(document.querySelector('#tablaRiesgos'),
    ['Oferente','Nivel','Cláusula','Página','Descripción'],
    riesgoRows.map(r=>({'Oferente':r.oferente,'Nivel':r.nivel,'Cláusula':r.clausula,'Página':r.pagina,'Descripción':r.descripcion}))
  );
}
function onFiltersChange(){ renderKPIs(); renderImpacto(); renderRadar(); renderBarras(); renderTablas(); }

/* ===================== Utilidades ===================== */
function normName(s){ return (s||'').normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/\s+/g,' ').trim().toLowerCase(); }
function normRuc(r){ const d = (r||'').toString().replace(/\D+/g,''); return d || null; }
function dedupeOferentesByRuc(list){
  const map = new Map();
  list.forEach((o, idx) => { const key = normRuc(o.ruc) || `name:${normName(o.nombre||'')}`; map.set(key, { ...o, _lastIdx: idx }); });
  return Array.from(map.values()).sort((a,b)=>a._lastIdx - b._lastIdx).map((o,i)=>({ ...o, id:`O${i+1}` }));
}

/* ===================== Arranque ===================== */
document.addEventListener('DOMContentLoaded', async()=>{
  try { await cargarTipoSeleccionado(); }
  catch { mostrarMensaje('No pude cargar datos iniciales. Selecciona un tipo y presiona "Cargar por tipo".'); }
});

})();</script>
</body>
</html>
