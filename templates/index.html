<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>RAG Licitaciones ‚Äì Front</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Usa tu CSS principal -->
  <link rel="stylesheet" href="/static/styles.css">
  <link rel="icon" href="/static/favicon.png" type="image/png">
</head>
<body>
<div class="chat-shell">
    <div class="chat-topbar">
      <div class="brand">Asistente NeuroByte-IA</div>
    </div>

    <div class="chat-container">
      <section>
        <h2 class="section-title">Analizador de documentos</h2>

        <!-- NUEVO: selector de proceso -->
        <div class="row">
          <label for="process" class="tiny" style="min-width:160px">Tipo de proceso</label>
          <select id="process" class="input" style="max-width:520px">
            <!-- Se poblar√° con "Familia ‚Äî Procedimiento" -->
          </select>
        </div>

        <div class="row">
          <input id="q" class="input" type="text" placeholder="Pregunta sobre el proceso aqui! ... (Opcional)" />
          <button id="ask" class="btn">Analizar</button>
        </div>
        <div id="chat" class="chat-box"></div>
      </section>
      <!-- Barra de progreso (autosuficiente) -->
      <div id="pwrap" style="display:none; margin-top:12px;">
        <div style="height:10px;background:#16213a;border-radius:10px;overflow:hidden;">
          <div id="pbar" style="height:10px;width:0%;background:#46a6ff;transition:width .25s ease;"></div>
        </div>
        <div id="ptext" style="font-size:.9rem;margin-top:6px;opacity:.85;">Preparando‚Ä¶</div>
      </div>

      <section class="u-mt">
        <h2 class="section-title">Cargar documentos</h2>
        <div class="row">
          <input id="files" type="file" accept="application/pdf" />
          <button id="upload" class="btn">Subir</button>
          <span id="status" class="tiny"></span>
        </div>
        <div id="list" class="tiny">No hay archivos a√∫n.</div>
      </section>
    </div>
  </div>


<script>
// ===== Config =====
const API_BASE = localStorage.getItem("API_BASE") || "http://127.0.0.1:8000";


// ===== Helpers UI =====
const $chat = document.getElementById("chat");
const $q    = document.getElementById("q");
const $files= document.getElementById("files");
const $list = document.getElementById("list");
const $status = document.getElementById("status");

const $process = document.getElementById("process");
let lastProcessSelection = localStorage.getItem("processSelection") || "auto";

function addMsg(text, cls="bot"){
  const div = document.createElement("div");
  div.className = `msg ${cls}`;
  div.innerHTML = text;
  $chat.appendChild(div);
  $chat.scrollTop = $chat.scrollHeight;
}
function addUser(text){ addMsg(escapeHtml(text), "user"); }
function addBot(text){ addMsg(text, "bot"); }

function escapeHtml(str){
  return String(str).replace(/[&<>"'`=\/]/g, s => (
    {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;','/':'&#x2F;','`':'&#x60;','=':'&#x3D;'}[s]
  ));
}

function pretty(obj){
  try{ return `<pre>${JSON.stringify(obj, null, 2)}</pre>`; }
  catch{ return `<pre>${obj}</pre>`; }
}

// ===== API calls =====
async function apiPost(path, body){
  const r = await fetch(`${API_BASE}${path}`, {
    method: "POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify(body || {})
  });
  if(!r.ok) throw new Error(`${r.status} ${r.statusText}`);
  return r.json();
}
async function apiGet(path){
  const r = await fetch(`${API_BASE}${path}`);
  if(!r.ok) throw new Error(`${r.status} ${r.statusText}`);
  return r.json();
}
async function apiUpload(path, files){
  const fd = new FormData();
  for(const f of files) fd.append("files", f);
  const r = await fetch(`${API_BASE}${path}`, { method:"POST", body: fd });
  if(!r.ok) throw new Error(`${r.status} ${r.statusText}`);
  return r.json();
}

// ===== Procesos ===== (NUEVO)
async function loadProcesses() {
  try {
    const r = await apiGet("/api/processes"); // requiere el endpoint sugerido
    const items = (r && r.items) ? r.items : [];
    populateProcessCombo(items);
  } catch (e) {
    // Fallback: lista m√≠nima por si el endpoint no existe a√∫n
    const fallback = [
      { familia: "bienes_servicios", procedimiento: "Cotizacion" },
      { familia: "bienes_servicios", procedimiento: "Licitacion" },
      { familia: "bienes_servicios", procedimiento: "Menor Cuantia" },
      { familia: "consultoria", procedimiento: "Licitacion" },
      { familia: "obras", procedimiento: "Cotizacion" },
      { familia: "obras", procedimiento: "Menor Cuantia" },
      { familia: "seguros", procedimiento: "Licitacion" },
      { familia: "regimen_especial", procedimiento: "Pliego" },
    ];
    populateProcessCombo(fallback);
  }
}

function populateProcessCombo(items){
  // conservar "auto"
  const current = localStorage.getItem("processSelection");
  // limpia todo salvo el primer option
  for(let i = $process.options.length - 1; i >= 1; i--) $process.remove(i);

  items.forEach(p => {
    const text = `${labelFamilia(p.familia)} ‚Äî ${labelProc(p.procedimiento)}`;
    const opt = document.createElement("option");
    opt.value = JSON.stringify({ familia: p.familia, procedimiento: p.procedimiento });
    opt.textContent = text;
    $process.appendChild(opt);
  });

  if (current) {
    // intenta restaurar
    const idx = [...$process.options].findIndex(o => o.value === current);
    if (idx >= 0) $process.selectedIndex = idx;
  }
}

function labelFamilia(f){
  const map = {
    bienes_servicios: "Bienes y Servicios",
    consultoria: "Consultor√≠a",
    obras: "Obras",
    seguros: "Licitaci√≥n de Seguros",
    regimen_especial: "R√©gimen Especial"
  };
  return map[f] || f || "‚Äî";
}
function labelProc(p){
  const map = {
    Cotizacion: "Cotizaci√≥n",
    Licitacion: "Licitaci√≥n",
    "Menor Cuantia": "Menor Cuant√≠a",
    "Subasta Inversa Electr√≥nica": "Subasta Inversa Electr√≥nica",
    Pliego: "Pliego"
  };
  return map[p] || p || "‚Äî";
}

function getSelectedProcess(){
  const v = $process.value;
  if (!v || v === "auto") return null;
  try { return JSON.parse(v); } catch { return null; }
}

// guarda selecci√≥n y notifica al backend
$process.addEventListener("change", async () => {
  const selected = $process.value || "auto";

  try {
    const res = await fetch(`${API_BASE}/api/cambioTipoDoc?process=${encodeURIComponent(selected)}`, {
      method: "GET"
    });

    if (res.status === 204) {
      localStorage.setItem("processSelection", selected);
      lastProcessSelection = selected;
      if ($chat) $chat.textContent = "";
      $list.textContent = "No hay archivos a√∫n.";
    } else {
      $process.value = lastProcessSelection;
    }
  } catch (e) {
    $process.value = lastProcessSelection;
  }
});


// ===== Events =====
document.getElementById("ask").onclick = async () => {
  const btn = document.getElementById("ask");
  const query = $q.value.trim();            // puede ir vac√≠o
  const process = getSelectedProcess();      // toma del combo "Tipo de proceso"

  // pinta el mensaje del usuario solo si escribi√≥ algo
  if (query) addUser(query);

  btn.disabled = true;
  startProgress();

  try {
    // Llama al backend aunque query est√© vac√≠o (usa el prompt por defecto del backend)
    const data = await apiPost("/api/chat", { query, process });

    // üÜï Caso: ya hab√≠a an√°lisis ‚Üí backend devuelve { respuesta_chat: "..." }
    if (typeof data?.respuesta_chat === "string" && data.respuesta_chat.trim()) {
      addBot(escapeHtml(data.respuesta_chat));
      return;
    }

    const r1 = data?.respuesta1;
    const r2 = data?.respuesta2;

    // ‚Äî‚Äî‚Äî Header compacto con sem√°foro por archivo + comparativo ‚Äî‚Äî
    // lee sem√°foros desde respuesta2
    const sems = (r2?.por_archivo || []).map(x => {
      const arch = x?.archivo || "Oferta";
      const sem  = (x?.json?.semaforo || "").toLowerCase();
      const color =
        sem === "aprobado"   ? "#2ecc71" :
        sem === "faltan_requisitos"? "#f1c40f" :
        sem === "no_cumple"    ? "#e74c3c" : "#7f8c8d";
      return `<span style="display:inline-block;padding:.1rem .5rem;border-radius:999px;background:${color}22;border:1px solid ${color};margin:.15rem .25rem .15rem 0">
        <b style="color:${color}">${sem||"N/D"}</b> ‚Äî ${escapeHtml(arch)}
      </span>`;
    }).join("");

    // comparativo texto
    const compTxt = r1?.comparativo_texto ? `<div style="margin:.25rem 0 .5rem 0"><b>Comparativo:</b> ${escapeHtml(r1.comparativo_texto)}</div>` : "";

    if (sems || compTxt) {
      addBot(`<div>${sems}${compTxt}</div>`);
    }

    if (r1?.por_archivo?.length) {
      r1.por_archivo.forEach(({ archivo, texto }) => {
        const nice = [`üóÇÔ∏è ${archivo || "Oferta_sin_nombre"}`, "", texto || "‚Äî"].join("\n");
        addBot(escapeHtml(nice));
      });
    } else {
      addBot("ü§∑ No hay narrativa para mostrar.");
    }

    if (r1?.comparativo_texto) {
      addBot("üìä Comparativo:\n" + escapeHtml(r1.comparativo_texto));
    } else if (r1?.comparativo) {
      addBot("üìä Comparativo:\n" + escapeHtml(JSON.stringify(r1.comparativo, null, 2)));
    }

    if (r2?.por_archivo?.length) {
      r2.por_archivo.forEach(({ archivo, json }) => {
        const jsonStr = JSON.stringify(json ?? {}, null, 2);
        addBot(escapeHtml(`üßæ JSON (decisi√≥n) ‚Äî ${archivo || "Oferta_sin_nombre"}\n${jsonStr}`));
      });
    } else {
      addBot("üß© No se gener√≥ JSON de decisi√≥n.");
    }
  } catch (e) {
    addBot(`‚ö†Ô∏è Error /api/chat<br>${escapeHtml(e.message)}`);
  } finally {
    stopProgress(true);
    btn.disabled = false;
    $q.value = ""; // limpia el campo
  }
};


document.getElementById("upload").onclick = async ()=>{
  const files = $files.files;
  if(!files || !files.length) return;
  $status.textContent = "Subiendo...";
  try{
    const data = await apiUpload("/api/upload-pdf", files);
    $status.textContent = "‚úÖ Listo";
    addBot(`Subidos: ${data.files.map(x=>x.filename).join(", ")}`);
    await refreshList();
  }catch(e){
    $status.textContent = "‚ö†Ô∏è Error al subir";
    addBot(`‚ö†Ô∏è Error /api/upload-pdf<br>${escapeHtml(e.message)}`);
  }finally{
    setTimeout(()=> $status.textContent="", 1500);
    $files.value = "";
  }
};

async function refreshList(){
  try{
    const data = await apiGet("/api/list-pdf");
    if(!data.files || !data.files.length){
      $list.textContent = "No hay archivos a√∫n.";
      return;
    }
    $list.innerHTML = data.files.map(f => (
      `<span class="chip">${escapeHtml(f.filename)} ¬∑ ${humanSize(f.size_bytes||0)}</span>`
    )).join("");
  }catch(e){
    $list.textContent = "‚ö†Ô∏è Error listando PDFs";
  }
}

function humanSize(bytes){
  const units = ['B','KB','MB','GB','TB'];
  let i = 0, n = Math.max(0, bytes);
  while(n >= 1024 && i < units.length-1){ n/=1024; i++; }
  return `${n.toFixed(n >= 10 || i === 0 ? 0 : 1)} ${units[i]}`;
}
// === Progreso (inline, sin tocar tu CSS global) ===
function startProgress(){
  const wrap = document.getElementById('pwrap'); if (!wrap) return;
  wrap.style.display='block';
  setProgress(5, 'Preparando‚Ä¶');

  // simulaci√≥n por fases hasta 90% mientras esperamos
  const phases = [
    {to: 20, text: 'Leyendo archivos‚Ä¶'},
    {to: 45, text: 'Indexando oferta‚Ä¶'},
    {to: 70, text: 'Seleccionando BASE‚Ä¶'},
    {to: 90, text: 'Construyendo contexto‚Ä¶'}
  ];
  let idx = 0;
  window.__pTimer && clearInterval(window.__pTimer);
  window.__pPct = 5;

  window.__pTimer = setInterval(()=>{
    const target = phases[Math.min(idx, phases.length-1)].to;
    if (window.__pPct < target) {
      window.__pPct = Math.min(target, window.__pPct + 2);
      setProgress(window.__pPct, phases[idx].text);
    } else {
      idx = Math.min(idx+1, phases.length-1);
    }
  }, 300);
}
function setProgress(pct, text){
  const bar = document.getElementById('pbar'); if (bar) bar.style.width = pct + '%';
  const txt = document.getElementById('ptext'); if (txt && text) txt.textContent = text;
}
function stopProgress(ok=true){
  window.__pTimer && clearInterval(window.__pTimer);
  setProgress(100, ok ? 'An√°lisis completado' : 'Error en el an√°lisis');
  const wrap = document.getElementById('pwrap');
  if (wrap) setTimeout(()=>{ wrap.style.display='none'; setProgress(0,''); }, 900);
}

refreshList();
loadProcesses();
</script>



</body>
</html>
