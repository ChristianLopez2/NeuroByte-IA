<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>RAG Licitaciones ‚Äì Front</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Usa tu CSS principal -->
  <link rel="stylesheet" href="/static/styles.css">
  <link rel="icon" href="/static/favicon.png" type="image/png">
</head>
<body>
<div class="chat-shell">
    <div class="chat-topbar">
      <div class="brand">Asistente IA RAG üìö</div>
    </div>

    <div class="chat-container">
      <section>
        <h2 class="section-title">Chat / An√°lisis</h2>
        <div class="row">
          <input id="q" class="input" type="text" placeholder="Pregunta o instrucciones..." />
          <button id="ask" class="btn">Analizar</button>
        </div>
        <div id="chat" class="chat-box"></div>
      </section>

      <section class="u-mt">
        <h2 class="section-title">Subir PDFs (oferente)</h2>
        <div class="row">
          <input id="files" type="file" accept="application/pdf" multiple />
          <button id="upload" class="btn">Subir</button>
          <button id="refresh" class="btn ghost">Actualizar lista</button>
          <span id="status" class="tiny"></span>
        </div>
        <div id="list" class="tiny">No hay archivos a√∫n.</div>
      </section>
    </div>
  </div>


<script>
// ===== Config =====
const API_BASE = localStorage.getItem("API_BASE") || "http://127.0.0.1:8000";


// ===== Helpers UI =====
const $chat = document.getElementById("chat");
const $q    = document.getElementById("q");
const $files= document.getElementById("files");
const $list = document.getElementById("list");
const $status = document.getElementById("status");

function addMsg(text, cls="bot"){
  const div = document.createElement("div");
  div.className = `msg ${cls}`;
  div.innerHTML = text;
  $chat.appendChild(div);
  $chat.scrollTop = $chat.scrollHeight;
}
function addUser(text){ addMsg(escapeHtml(text), "user"); }
function addBot(text){ addMsg(text, "bot"); }

function escapeHtml(str){
  return String(str).replace(/[&<>"'`=\/]/g, s => (
    {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;','/':'&#x2F;','`':'&#x60;','=':'&#x3D;'}[s]
  ));
}

function pretty(obj){
  try{ return `<pre>${JSON.stringify(obj, null, 2)}</pre>`; }
  catch{ return `<pre>${obj}</pre>`; }
}

// ===== API calls =====
async function apiPost(path, body){
  const r = await fetch(`${API_BASE}${path}`, {
    method: "POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify(body || {})
  });
  if(!r.ok) throw new Error(`${r.status} ${r.statusText}`);
  return r.json();
}
async function apiGet(path){
  const r = await fetch(`${API_BASE}${path}`);
  if(!r.ok) throw new Error(`${r.status} ${r.statusText}`);
  return r.json();
}
async function apiUpload(path, files){
  const fd = new FormData();
  for(const f of files) fd.append("files", f);
  const r = await fetch(`${API_BASE}${path}`, { method:"POST", body: fd });
  if(!r.ok) throw new Error(`${r.status} ${r.statusText}`);
  return r.json();
}

// ===== Events =====
document.getElementById("ask").onclick = async () => {
  const query = $q.value.trim();
  if (!query) return;
  addUser(query);
  $q.value = "";

  try {
    const data = await apiPost("/api/chat", { query });

    // Mostrar resultado principal
    addBot(escapeHtml(data.result || "Sin respuesta üòÖ"));

    // Mostrar an√°lisis global
    if (data.analysis) {
      const analysisStr = typeof data.analysis === "string"
        ? data.analysis
        : JSON.stringify(data.analysis, null, 2);
      addBot("üìä An√°lisis global:\n" + escapeHtml(analysisStr));
    }

    // Mostrar an√°lisis por oferta
    if (data.per_offer_analysis) {
      const perOfferStr = typeof data.per_offer_analysis === "string"
        ? data.per_offer_analysis
        : JSON.stringify(data.per_offer_analysis, null, 2);
      addBot("üìÇ An√°lisis por oferta:\n" + escapeHtml(perOfferStr));
    }

  } catch (e) {
    addBot(`‚ö†Ô∏è Error /api/chat<br>${escapeHtml(e.message)}`);
  }
};

document.getElementById("upload").onclick = async ()=>{
  const files = $files.files;
  if(!files || !files.length) return;
  $status.textContent = "Subiendo...";
  try{
    const data = await apiUpload("/api/upload-pdf", files);
    $status.textContent = "‚úÖ Listo";
    addBot(`Subidos: ${data.files.map(x=>x.filename).join(", ")}`);
    await refreshList();
  }catch(e){
    $status.textContent = "‚ö†Ô∏è Error al subir";
    addBot(`‚ö†Ô∏è Error /api/upload-pdf<br>${escapeHtml(e.message)}`);
  }finally{
    setTimeout(()=> $status.textContent="", 1500);
    $files.value = "";
  }
};

document.getElementById("refresh").onclick = refreshList;

async function refreshList(){
  try{
    const data = await apiGet("/api/list-pdf");
    if(!data.files || !data.files.length){
      $list.textContent = "No hay archivos a√∫n.";
      return;
    }
    $list.innerHTML = data.files.map(f => (
      `<span class="chip">${escapeHtml(f.filename)} ¬∑ ${humanSize(f.size_bytes||0)}</span>`
    )).join("");
  }catch(e){
    $list.textContent = "‚ö†Ô∏è Error listando PDFs";
  }
}

function humanSize(bytes){
  const units = ['B','KB','MB','GB','TB'];
  let i = 0, n = Math.max(0, bytes);
  while(n >= 1024 && i < units.length-1){ n/=1024; i++; }
  return `${n.toFixed(n >= 10 || i === 0 ? 0 : 1)} ${units[i]}`;
}

refreshList();
</script>
</body>
</html>
